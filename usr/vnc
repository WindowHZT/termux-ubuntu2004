#!/bin/bash
#å­—ä½“é¢œè‰²
red="\e[31;1m"      #çº¢
green="\e[32;1m"   #ç»¿
yellow="\e[33;1m"  #é»„
blue="\e[34;1m"    #è“
purple="\e[35;1m"    #ç´«çº¢
cyanine="\e[36;1m"    #é’è“
white="\e[0m"

CONFIG=/usr/local/bin/.config

msg() { clear;echo -e "\n\t\t$blue[*]$white$1$2$white\n" ;:;}  ##è‡ªå®šä¹‰é€šå‘Šé¢œè‰²




_login(){
	i=0
	str=""
	label=('|' '/' '-' '\\')
	index=0
	while [ $i -le 20 ]
	do
		let index=i%4
		let jinshu=$i*5
		printf "\e[0m\e[32m[%-20s]\e[0m\e[0;32m[%c]\e[1;0m\e[0;35m[%-3d%%]\e[1;0m\r" $str ${label[$index]} $jinshu
		let i++
		str+="#"
		sleep 0.1
	done
	echo
}


_start(){
	clear
	echo -e "\n$redå¯†ç ä¸º$green$USER$redçš„å¯†ç $white"
	sudo echo 
	service dbus restart
	service dbus stop
	dbus-daemon --system
	service dbus status 
	
	##å¯åŠ¨tigervnc 
	vncserver -kill :1  > /dev/null 2>&1
	source $CONFIG
	LD_PRELOAD=/lib/aarch64-linux-gnu/libgcc_s.so.1 vncserver -localhost no -depth 24 -name remote-desktop $GEO :$PORT
	
	##å¯åŠ¨xrdp
	if [ ! -z "$(command -v xrdp)" ];then
		xrdp -k
		rm -rf /var/run/xrdp/xrdp-sesman.pid
		rm -rf /var/run/xrdp/xrdp.pid
		sudo service xrdp restart
		sleep 0.9
		sudo service xrdp status
	fi
	
	service --status-all

	[ ! -e "/data/data/com.termux/files/home/storage/shared/swap" ]&&mkdir /data/data/com.termux/files/home/storage/shared/swap
	[ ! -e "`echo ~/Desktop/MTS`" ]&&mkdir ~/Desktop/MTS
	[ ! -L "`echo ~/Desktop/MTS/swap`" ]&&ln -s /data/data/com.termux/files/home/storage/shared/swap ~/Desktop/MTS
	[ ! -L "`echo ~/Desktop/MTS/Download`" ]&&ln -s /data/data/com.termux/files/home/storage/shared/Download ~/Desktop/MTS
	#[ ! -L "`echo ~/Desktop/MTS/QQfile_recv`" ]&&ln -s /data/data/com.termux/files/home/storage/shared/Android/data/com.tencent.mobileqq/Tencent/QQfile_recv ~/Desktop/MTS
	if [ ! -e "`echo ~/Desktop/MTS/è¯´æ˜.txt`" ];then
		touch ~/Desktop/MTS/è¯´æ˜.txt
		cat <<-EOF >~/Desktop/MTS/è¯´æ˜.txt
		|************************|
		PSï¼š1.è¿™ä¸ªMTSç›®å½•æ˜¯è¿æ¥åˆ°æ‰‹æœºå­˜å‚¨ç›®å½•çš„äº¤æ¢åŒºã€‚
			 2.æ–¹ä¾¿éRootç”¨æˆ·å­˜å–æ–‡ä»¶ï¼Œå’Œäº¤æ¢æ–‡ä»¶ã€‚
			 3.æ¯ä¸€æ¬¡å¼€æœºéƒ½ä¼šè‡ªåŠ¨åˆ›å»ºè¿™ä¸ªç›®å½•ï¼Œä¸ç”¨æ‹…å¿ƒå®ƒè¢«åˆ é™¤ã€‚
			 
		ä½¿ç”¨æ–¹æ³•ï¼šstep1.åœ¨ä½ æ‰‹æœºè‡ªå¸¦çš„æ–‡ä»¶ç®¡ç†å™¨æ‰¾åˆ° MTS è¿™ä¸ªç›®å½•ã€‚
				   step2.æŠŠä½ ä¸‹è½½çš„åˆ˜å¾·åæœ€æ–°æ­Œæ›²mp3æ–‡ä»¶ï¼Œå¤åˆ¶ä¸€ä»½åˆ°è¿™ä¸ªç›®å½•ã€‚
				   step3.æ‰“å¼€ä½ çš„ubuntuç³»ç»Ÿï¼Œåœ¨æ¡Œé¢ç‚¹å‡» MTS ç›®å½•å°±å¯ä»¥çœ‹è§ä½ çš„mp3æ­Œæ›²äº†ã€‚
				   
		æ³¨æ„ï¼šåŒæ ·çš„ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠubuntué‡Œé¢çš„åŠå…¬æ–‡ä»¶ç§»åŠ¨åˆ° MTS è¿™ä¸ªç›®å½•ï¼Œç„¶åå»ä½ æ‰‹æœºæ–‡
			  ä»¶ç®¡ç†å™¨å°±å¯ä»¥è½»æ¾è·å–åˆ°ä½ çš„åŠå…¬æ–‡ä»¶äº†
			  
		ä¼˜ç‚¹ï¼šè§£å†³äº†è™šæ‹Ÿæœºä¸ç‰©ç†æœºæ–‡ä»¶äº¤æ¢ç¹æ‚çš„é—®é¢˜ã€‚
		å¾…æ”¹è¿›ï¼šè§£é™¤å®‰å“11ç³»ç»Ÿé™åˆ¶è®¿é—®dataæ–‡ä»¶å¤¹
		
		|************************|
		å…³äºè¾“å…¥æ³•è¯´æ˜ï¼š
				1ï¼‰åˆ‡æ¢ä¸­/è‹± å¿«æ·é”®æ˜¯ Ctrl+ç©ºæ ¼
		
		
		æ‰‹æœºQQæ¥æ”¶çš„æ–‡ä»¶åœ¨ä¸‹é¢è¿™ä¸ªç›®å½•ï¼ˆæš‚æœªå®ç°é“¾æ¥åˆ°è¾¾æœ¬æœºï¼‰
		/storage/emulated/0/Android/data/com.tencent.mobileqq/Tencent/QQfile_recv/
		EOF
	fi
	
	_login
	msg $green "ubuntu20.04å¼€æœºå®Œæ¯•Â·æ¬¢è¿~"
	echo -e "\t$redè·å–æ›´å¤šå¸®åŠ©è¯·ä½¿ç”¨å‘½ä»¤ ubuntu$white"
}


_stop(){
	USER=$(whoami)
	msg $red "VNCæœåŠ¡åˆ—è¡¨å¦‚ä¸‹ï¼š"
	vncserver -list
	echo -n "è¾“å…¥éœ€è¦æ€æ­»çš„ç«¯å£å·(ç¤ºä¾‹:3):"
	read pt
	echo " "
	echo "å·²æ€æ­»çš„ç«¯å£ $pt"
	vncserver -kill :$pt
	rm -rf /tmp/.X$pt-lock
	rm -rf /tmp/.X11-unix/X$pt
}


_PWD(){
	read -sp 'è¯·æä¾›ä¸€ä¸ªæ–°çš„VNCå¯†ç : ' PASSWORD
	vncpasswd -f <<<"$PASSWORD\n$PASSWORD" > $HOME/.vnc/passwd
	msg $green "VNCç™»å½•å¯†ç å·²ä¿®æ”¹ï¼"
}




_DPI(){
	export USER=$(whoami)
	export LC_ALL="zh_CN.UTF-8"
	HEIGHT=0
	WIDTH=0
	CHOICE_HEIGHT=5
	BACKTITLE="VNC åˆ†è¾¨ç‡é€‰æ‹©"
	TITLE="vncserver-start"
	MENU="è¯·é€‰æ‹©ä½ çš„åˆ†è¾¨ç‡"
	export PORT=1
	
	OPTIONS=(
         1 "QHD 2kç”»è´¨(2560x1600)"
         2 "FHD 1080pç”»è´¨(1920x1080)"
         3 "HD-ready é«˜æ¸…ç”»è´¨(1280x720)"
         4 "è‡ªåŠ¨ç”»è´¨"
         5 "è‡ªå®šä¹‰ç”»è´¨/ç«¯å£")

	CHOICE=$(dialog --clear \
                --backtitle "$BACKTITLE" \
                --title "$TITLE" \
                --menu "$MENU" \
                $HEIGHT $WIDTH $CHOICE_HEIGHT \
                "${OPTIONS[@]}" \
                2>&1 >/dev/tty)

	clear
	case $CHOICE in
        1)
            echo "ä½ é€‰æ‹©äº†QHD 2kç”»è´¨(2560x1600)"
            sed -i "s#`cat $CONFIG | grep "GEO=" |awk -F '"' '{print $2}'`#-geometry 2560x1600#g" $CONFIG
            ;;
        2)
            echo "ä½ é€‰æ‹©äº†FHD 1080pç”»è´¨(1920x1080)"
            sed -i "s#`cat $CONFIG | grep "GEO=" |awk -F '"' '{print $2}'`#-geometry 1920x1080#g" $CONFIG
            ;;
        3)
            echo "ä½ é€‰æ‹©äº†HD-ready é«˜æ¸…ç”»è´¨(1280x720)"
            sed -i "s#`cat $CONFIG | grep "GEO=" |awk -F '"' '{print $2}'`#-geometry 1280x720#g" $CONFIG
            ;;
        4)
            echo "ä½ é€‰æ‹©äº†è‡ªåŠ¨ç”»è´¨"
			sed -i "s#`cat $CONFIG | grep "GEO=" |awk -F '"' '{print $2}'`##g" $CONFIG
            ;;
        5)
            echo "æ‚¨é€‰æ‹©æ‰‹åŠ¨æä¾› åˆ†è¾¨ç‡/ç«¯å£"
            echo "è¾“å…¥æ‚¨çš„è‡ªå®šä¹‰åˆ†è¾¨ç‡æ ¼å¼WIDTHxHEIGHTå³1920x1200"
            echo -ne "åˆ†è¾¨ç‡ï¼š" ""
            read custom
            echo "è¾“å…¥æ‚¨çš„è‡ªå®šä¹‰ç«¯å£ï¼Œå³2" 
            echo -ne "ç«¯å£ï¼š" ""
            read port
            sed -i "s#`cat $CONFIG | grep "GEO=" |awk -F '"' '{print $2}'`#-geometry $custom#g" $CONFIG
            #echo "GEO=\"-geometry $custom\"" > $CONFIG
            #echo "PORT=$port" >> $CONFIG
            sed -i "s#`cat $CONFIG | grep "PORT="`#PORT=$port#g" $CONFIG
            ;;
	esac	
}

_xfce(){
	[ ! -e $CONFIG ]&&touch $CONFIG
    echo 'GEO="-geometry 2560x1600"' >> $CONFIG
    echo 'PORT=1' >> $CONFIG

	msg $red "å®‰è£…xfceæ¡Œé¢"
	echo -e "$redè¯·è¾“å…¥rootç”¨æˆ·çš„å¯†ç ï¼š$white"
	sudo apt purge dialog -y

	sudo  apt install eatmydata -y
	sudo eatmydata apt install software-properties-common -y
	sudo add-apt-repository ppa:xubuntu-dev/staging -y
	sudo apt-get update
	
	sudo eatmydata apt install keyboard-configuration -y
	sudo eatmydata apt install tzdata -y
	sudo eatmydata apt install sudo wget nano inetutils-tools dialog bc dbus-x11 -y 
	sudo eatmydata apt install xfce4 xfce4-goodies xfce4-terminal exo-utils tigervnc-standalone-server tigervnc-common  ffmpeg  language-pack-en --no-install-recommends -y
	sudo eatmydata apt clean git -y
	
	mkdir -p ~/.vnc
	USER=`cat /usr/local/bin/.USER`
	LD_PRELOAD=/lib/aarch64-linux-gnu/libgcc_s.so.1 vncpasswd -f <<< `cat /usr/local/bin/.PASSWORD` > "/home/$USER/.vnc/passwd"
	rm -rf /usr/local/bin/.PASSWORD

	#/usr/bin/vncpasswd -f <<<"$PASSWORD\n$PASSWORD" > "/home/$USER/.vnc/passwd"
	#vncpasswd -f <<<"$PASSWORD"$'\n'"$PASSWORD" > /root/.vnc/passwd 

	cat <<-EOF > ~/.vnc/xstartup
	#!/bin/bash
	[ -r \$HOME/.Xresources ] && xrdb \$HOME/.Xresources
	export PULSE_SERVER=127.0.0.1
	XAUTHORITY=\$HOME/.Xauthority
	export XAUTHORITY
	#LANG=en_US.UTF-8
	#export LANG
	echo \$\$ > /tmp/xsession.pid
	dbus-launch --exit-with-session startxfce4 &
	EOF
	
	for x in fonts-wqy-microhei  libglu1-mesa bsdmainutils xdg-utils libxslt-dev libxml2-dev python3-pyqt5 ttf-mscorefonts-installer man-db vim
	do
		sudo eatmydata apt install "$x" -y
	done
	
	##å®‰è£…fcitx
	sudo eatmydata apt purge ibus -y
	sudo eatmydata apt install fcitx fcitx-ui-qimpanel -y
	sudo eatmydata apt install fcitx-bin -y
	sudo eatmydata apt install fcitx-table -y
	sudo eatmydata apt install fcitx-pinyin -y
	#sudo eatmydata apt remove fcitx-ui-classic -y
	im-config fcitx
	sudo cp /usr/share/fcitx/xdg/autostart/fcitx-autostart.desktop /etc/xdg/autostart/

	echo "export DISPLAY=\":1\"" >> /etc/profile
	source /etc/profile
	
	[ -z "`dpkg -l | grep fonts-wqy-microhei`" ]&&sudo apt-get install fonts-wqy-microhei -y
	[ ! -z "`cat /etc/locale.gen|grep '# zh_CN.UTF-8 UTF-8'`" ]&&sed -i "s/# zh_CN.UTF-8 UTF-8/ zh_CN.UTF-8 UTF-8/g" /etc/locale.gen
	locale-gen
	echo "export LC_ALL=zh_CN.UTF-8" >> ~/.bashrc
	
	cat <<-EOF>> /etc/environment
	TMOE_PROOT=true
	MOZ_FAKE_NO_SANDBOX=1
	QT_QPA_PLATFORMTHEME=qt5ct
	SDL_IM_MODULE="fcitx"
	XMODIFIERS="@im=fcitx"
	QT_IM_MODULE="fcitx"
	GTK_IM_MODULE="fcitx"
	EOF

	sed -i "s#shuangpin:True#shuangpin:False#g" ~/.config/fcitx/profile
	sed -i "s#pinyin:True,#pinyin:True,#g" ~/.config/fcitx/profile
	sed -i "s#EnabledIMList=#EnabledIMList=pinyin:True,#g" ~/.config/fcitx/profile
	echo "TheInputMethod=1" >> $CONFIG
	
	cat <<-EOF>> ~/.bashrc
	if [ "\$TERM"="linux" ] ;then 
		#export LANGUAGE=en_US 
		echo ""
	fi 
	EOF
	
	##è®¾ç½®é¢æ¿å›¾æ ‡
	mkdir -p ~/.icons
	wget https://raw.githubusercontent.com/WindowHZT/termux-ubuntu2004/main/mix/ubuntu-logo-icon.png -O /tmp/ubuntu-logo-icon.png
	#wget gitee.com/djyd/termux-ubuntu2004/raw/main/mix/ubuntu-logo-icon.png	 -O /tmp/ubuntu-logo-icon.png
	
	cat<<-EOF > "/usr/share/applications/ubuntu.desktop"
	[Desktop Entry]
	Version=1.0
	Name=ubuntu
	StartupNotify=true
	OnlyShowIn=XFCE;
	X-AppStream-Ignore=True
	Exec=/usr/local/bin/ubuntu
	Terminal=true
	X-MultipleArgs=false
	Type=Application
	Icon=/tmp/ubuntu-logo-icon.png
	EOF
	
	sudo chmod 644 /usr/share/applications/ubuntu.desktop

	if [ -f /etc/dpkg/dpkg.cfg.d/excludes ] || [ -f /etc/dpkg/dpkg.cfg.d/excludes.dpkg-tmp ]; then
	    if [ -f /etc/dpkg/dpkg.cfg.d/excludes ]; then
 	       mv /etc/dpkg/dpkg.cfg.d/excludes /etc/dpkg/dpkg.cfg.d/excludes.dpkg-tmp
		fi

		apt-get update -y
	 	apt-get upgrade -y
		dpkg -S /usr/share/man/ |sed 's|, |\n|g;s|: [^:]*$||' | DEBIAN_FRONTEND=noninteractive xargs apt-get install --reinstall -y
		dpkg --verify --verify-format rpm | awk '/..5......   \/usr\/share\/doc/ {print $2}' | sed 's|/[^/]*$||' | sort |uniq \
 	        | xargs dpkg -S | sed 's|, |\n|g;s|: [^:]*$||' | uniq | DEBIAN_FRONTEND=noninteractive xargs apt-get install --reinstall -y
		dpkg --verify --verify-format rpm | awk '/..5......   \/usr\/share\/locale/ {print $2}' | sed 's|/[^/]*$||' | sort |uniq \
			| xargs dpkg -S | sed 's|, |\n|g;s|: [^:]*$||' | uniq | DEBIAN_FRONTEND=noninteractive xargs apt-get install --reinstall -y
    
		if dpkg --verify --verify-format rpm | awk '/..5......   \/usr\/share\/doc/ {exit 1}'; then
			rm /etc/dpkg/dpkg.cfg.d/excludes.dpkg-tmp
		else
			dpkg --verify --verify-format rpm | awk '/..5......   \/usr\/share\/doc/ {print " " $2}'
		fi
	fi



	if  [ "$(dpkg-divert --truename /usr/bin/man)" = "/usr/bin/man.REAL" ]; then
		rm -f /usr/bin/man
		dpkg-divert --quiet --remove --rename /usr/bin/man
	fi
	rm -f /etc/update-motd.d/60-unminimize

}



if [ ! -e $CONFIG  ];then

	_xfce
	_DPI
	service dbus start
	_start
	
	#æ·»åŠ é¢æ¿æ•°ç»„
	xfconf-query -c xfce4-panel -np /panels/panel-2/plugin-ids -t 'int' -s 15 -t 'int' -s 16 -t 'int' -s 17 -t 'int' -s 18 -t 'int' -s 19 -t 'int' -s 20 -t 'int' -s 34 -t 'int' -s 33 -t 'int' -s 21 -t 'int' -s 22
	
	##å¢åŠ ubuntu
	xfconf-query -c xfce4-panel -np "/plugins/plugin-33" -t 'string' -s "launcher"
	xfconf-query -c xfce4-panel -np "/plugins/plugin-33/items" -t 'string' -a -s "ubuntu.desktop"
	
	##å¢åŠ æˆªå›¾
	xfconf-query -c xfce4-panel -np "/plugins/plugin-34" -t 'string' -s "launcher"
	xfconf-query -c xfce4-panel -np "/plugins/plugin-34/items" -t 'string' -a -s "xfce4-screenshooter.desktop"

	##è®¾ç½®çŠ¶æ€æ å›¾æ ‡
	xfconf-query -c xfce4-panel -np '/plugins/plugin-1/button-icon' -t 'string' -s "/tmp/ubuntu-logo-icon.png"
	##è®¾ç½®çŠ¶æ€æ å¤§å°
	xfconf-query -c xfce4-panel -np '/panels/panel-1/icon-size' -t 'int' -s 20
	##è®¾ç½®planké¢æ¿å›¾æ ‡å¤§å°
	xfconf-query -c xfce4-panel -np '/panels/panel-2/size' -t 'int' -s 100
	##è®¾ç½®å­—ä½“å¤§å°
	xfconf-query -c xsettings -np '/Xft/DPI' -t 'int' -s 200
	##è®¾ç½®æ¡Œé¢å›¾æ ‡å¤§å°
	xfconf-query -c xfce4-desktop -np '/desktop-icons/icon-size' -t 'int' -s 100
	
	echo "284684.56 513853.46" > /proc/uptime
	echo "0.54 0.41 0.30 1/931 370386" >/proc/loadavg
:<<EO
	msg $red "å¼€å§‹æ±‰åŒ–xfce4æ¡Œé¢^_^"
	if [ -f /etc/dpkg/dpkg.cfg.d/excludes ] || [ -f /etc/dpkg/dpkg.cfg.d/excludes.dpkg-tmp ]; then
	    if [ -f /etc/dpkg/dpkg.cfg.d/excludes ]; then
 	       sudo  mv /etc/dpkg/dpkg.cfg.d/excludes /etc/dpkg/dpkg.cfg.d/excludes.dpkg-tmp
		fi

		sudo apt-get update -y
	 	sudo apt-get upgrade -y
		sudo dpkg -S /usr/share/man/ |sed 's|, |\n|g;s|: [^:]*$||' | DEBIAN_FRONTEND=noninteractive xargs sudo apt-get install --reinstall -y
		sudo dpkg --verify --verify-format rpm | awk '/..5......   \/usr\/share\/doc/ {print $2}' | sed 's|/[^/]*$||' | sort |uniq \
 	        | xargs sudo dpkg -S | sed 's|, |\n|g;s|: [^:]*$||' | uniq | DEBIAN_FRONTEND=noninteractive xargs sudo apt-get install --reinstall -y
		sudo dpkg --verify --verify-format rpm | awk '/..5......   \/usr\/share\/locale/ {print $2}' | sed 's|/[^/]*$||' | sort |uniq \
			| xargs sudo dpkg -S | sed 's|, |\n|g;s|: [^:]*$||' | uniq | DEBIAN_FRONTEND=noninteractive xargs sudo apt-get install --reinstall -y
    
		if sudo dpkg --verify --verify-format rpm | awk '/..5......   \/usr\/share\/doc/ {exit 1}'; then
			sudo rm /etc/dpkg/dpkg.cfg.d/excludes.dpkg-tmp
		else
			sudo dpkg --verify --verify-format rpm | awk '/..5......   \/usr\/share\/doc/ {print " " $2}'
		fi
	fi

	if  [ "$(sudo dpkg-divert --truename /usr/bin/man)" = "/usr/bin/man.REAL" ]; then
		sudo rm -f /usr/bin/man
		sudo dpkg-divert --quiet --remove --rename /usr/bin/man
	fi
	sudo rm -f /etc/update-motd.d/60-unminimize
EO

	startTime=`cat /data/data/com.termux/files/home/Time`
	rm -rf /data/data/com.termux/files/home/Time
	endTime=`date +"%Y-%m-%d %H:%M:%S"`
	st=`date -d  "$startTime" +%s`
	et=`date -d  "$endTime" +%s`
	sumTime=$(($et-$st))
	
	echo -e "\n\n\tå®‰è£…ubuntu20.04æ€»è€—æ—¶ : `echo $sumTime/60 | bc` Minutes."
	echo -e "$red æŒ‰ä¸‹å›è½¦å…³æœºï¼Œé‡æ–°æ‰“å¼€è½¯ä»¶å³å¯å†²æµªğŸ„$white"
	read op
	kill -9 `sudo ps -ef | grep '/data/data/com.termux/files/usr/bin/bash -l' | grep -v grep | awk '{print $2}'`

fi

case $1 in
	"start")  ##å¯åŠ¨vnc
		_start
		;;
	"stop")  ##åœæ­¢vnc
		_stop
		;;
	"changeDPI")  ##æ”¹å˜vncåˆ†è¾¨ç‡
		_DPI
		;;
	"changePWD")  ##æ”¹å˜vncå¯†ç 
		_PWD
		;;
	*)
		echo -e "\tvnc å¸®åŠ©æ–‡æ¡£"
		echo -e "\t(1)ä½¿ç”¨å‘½ä»¤ vnc start å¯åŠ¨vncæœåŠ¡"
		echo -e "\t(2)ä½¿ç”¨å‘½ä»¤ vnc stop åœæ­¢vncæœåŠ¡"
		echo -e "\t(3)ä½¿ç”¨å‘½ä»¤ vnc changeDPI æ›´æ”¹vncåˆ†è¾¨ç‡"
		echo -e "\t(4)ä½¿ç”¨å‘½ä»¤ vnc changePWD æ›´æ”¹vncå¯†ç "
		;;
esac